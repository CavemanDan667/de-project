name: Security Checks and Testing

on: 
  push:
    branches:
      - '*'


jobs:
  test-and-security:
    name: test-and-security
    runs-on: ubuntu-latest
    # services:
    #   postgres:
    #     image: postgres:11
    #     env:
    #       POSTGRES_USER: postgres
    #       POSTGRES_PASSWORD: postgres
    #       POSTGRES_DB: postgres
    #       POSTGRES_HOST: postgres
    #     ports: ['5432:5432']
    steps:
        - name: Checkout Repo
          uses: actions/checkout@v4
        - name: Setup Python
          uses: actions/setup-python@v4
          with:
            python-version: '3.11.1'
        - name: Make Envfile
          uses: SpicyPizza/create-envfile@v2.0
          with:
            envkey_USER: ${{ secrets.DB_USER }}
            envkey_PASSWORD: ${{ secrets.DB_PASS }}
            envkey_HOST: postgres
            envkey_PORT: ${{ secrets.DB_PORT }}
            envkey_DATABASE: ${{ secrets.DB_DATABASE }}
        - name: Use Postgres
          uses: harmon758/postgresql-action@v1
          with:
            postgresql db: ${{ secrets.DB_DATABASE }}
            postgresql user: ${{ secrets.DB_USER }}
            postgresql password: ${{ secrets.DB_PASS }}
            postgresql host: postgres
            postgresql port: ${{ secrets.DB_PORT }}

        - name: Install Dependencies
          run: make requirements
        - name: Run Flake
          run: make run-flake
        - name: Run Security Checks
          run: make security-test
        - name: Seed DB
          run: psql -f curl ${{ secrets.DB_DATABASE }}
        - name: Connect to Database
          run: PG_DATABASE=${{ secrets.DB_PASS }} PG_USER=${{ secrets.DB_USER }} PG_PASSWORD=${{ secrets.DB_PASS }} PG_HOST=postgres PG_PORT=${{ secrets.DB_PORT }}
        # - name: Connect Database
          # uses: harmon758/postgresql-action@v1
          # with:
          #   postgresql version: '11'
          # run: psql -f ./mock_database/seed.sql
        # - name: Connect Empty Database
        #   uses: harmon758/postgresql-action@v1
        #   with:
        #     postgresql version: '11'
          # run: psql -f ./mock_database/seed_empty.sql
        - name: Check Coverage
          run: make check-coverage
  run-unit-tests: 
    name: run-unit-tests
    runs-on: ubuntu-latest
    needs: test-and-security
    steps: 
        - name: Checkout Repo
          uses: actions/checkout@v4
        - name: Setup Python
          uses: actions/setup-python@v4
          with:
            python-version: '3.11.1'
        - name: Install Dependencies
          run: make requirements
        - name: Unit Tests
          run: make unit-test

  



  # In a separate .yml:
  # deploy-terraform:
  #   name: deploy-terraform
  #   runs-on: ubuntu-latest
  #   needs: run-unit-tests
  #   steps: 
  #     - name: Checkout Repo
  #       uses: actions/checkout@4
  #     - name: Configure AWS CLI
  #       uses: aws-actions/configure-aws-credentials@4
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: eu-west-2
  #     - name: Setup Terraform
  #       uses: hashicorp/setup-terraform@v2
  #     - name: Terraform Init
  #       working-directory: terraform
  #       run: terraform init
  #     - name: Terraform Plan
  #       working-directory: terraform
  #       run: terraform plan
  #     - name: Terraform Apply
  #       working-directory: terraform
  #       run: terraform apply -auto-approve

    
